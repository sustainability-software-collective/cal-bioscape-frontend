steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== SECRET ACCESS TEST ==="
        echo "Testing access to 'mapbox-access-token' secret..."
        
        if [ -z "${MAPBOX_ACCESS_TOKEN:-}" ]; then 
          echo "❌ ERROR: Secret not found in environment"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Verify the secret exists:"
          echo "   gcloud secrets list --filter=mapbox-access-token"
          echo ""
          echo "2. Verify the secret has content:"
          echo "   gcloud secrets versions access latest --secret=mapbox-access-token | wc -c"
          echo ""
          echo "3. Grant access to Cloud Build:"
          echo "   PROJECT_NUMBER=\$(gcloud projects describe \$PROJECT_ID --format='value(projectNumber)')"
          echo "   gcloud projects add-iam-policy-binding \$PROJECT_ID \\"
          echo "     --member=serviceAccount:\$PROJECT_NUMBER@cloudbuild.gserviceaccount.com \\"
          echo "     --role=roles/secretmanager.secretAccessor"
          echo ""
          exit 1
        else 
          echo "✅ SUCCESS: Secret is available (${#MAPBOX_ACCESS_TOKEN} characters)"
          echo "First 3 chars: ${MAPBOX_ACCESS_TOKEN:0:3}..."
          echo ""
          echo "Your secret is accessible to Cloud Build. Now check your trigger settings:"
          echo "1. Go to Console > Cloud Build > Triggers"
          echo "2. Edit your trigger"
          echo "3. Under Configuration, select 'Cloud Build configuration file'"
          echo "4. Set location to 'cloudbuild.yaml'"
          echo "5. Save and run the trigger"
        fi

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/mapbox-access-token/versions/latest
      env: 'MAPBOX_ACCESS_TOKEN'
